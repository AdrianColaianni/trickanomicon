\documentclass[12pt,letterpaper]{article}
\usepackage[margin=1in]{geometry}


% Font w/ xelatex
\ifxetex
	\usepackage{fontspec}
	\setsansfont{Jost.ttf}[
	BoldFont = Jost-Bold.ttf ,
	ItalicFont = Jost-Italic.ttf ,
	BoldItalicFont = Jost-BoldItalic.ttf]
	\renewcommand{\familydefault}{\sfdefault}
	\setmonofont{FiraCode Nerd Font}
\else
	\renewcommand{\familydefault}{\sfdefault}
\fi

% Quotes
\usepackage[american]{babel}

% Rose Pine
\usepackage{xcolor}
% \def\light{1}
\ifx\light\defined
	\definecolor{base}{HTML}{1f1d2e}
	\definecolor{muted}{HTML}{6e6a86}
	\definecolor{subtle}{HTML}{908caa}
	\definecolor{text}{HTML}{e0def4}
	\definecolor{love}{HTML}{eb6f92}
	\definecolor{gold}{HTML}{f6c177}
	\definecolor{rose}{HTML}{ea9a97}
	\definecolor{pine}{HTML}{3e8fb0}
	\definecolor{foam}{HTML}{9ccfd8}
	\definecolor{iris}{HTML}{c4a7e7}
	\pagecolor{base}
	\color{text}
\else
	\definecolor{base}{HTML}{faf4ed}
	\definecolor{muted}{HTML}{9893a5}
	\definecolor{subtle}{HTML}{797593}
	\definecolor{text}{HTML}{575279}
	\definecolor{love}{HTML}{b4637a}
	\definecolor{gold}{HTML}{ea9d34}
	\definecolor{rose}{HTML}{d7827e}
	\definecolor{pine}{HTML}{286983}
	\definecolor{foam}{HTML}{56949f}
	\definecolor{iris}{HTML}{907aa9}
	\pagecolor{base}
	\color{text}
\fi

% Images
% \usepackage{graphicx}
% \usepackage{wrapfig}
% \usepackage{float}

% \usepackage{pgfplots}
% \usepackage{multicol}
% \usepackage{lipsum}

% Set list numbering
\renewcommand{\labelenumi}{{\color{iris}\arabic{enumi}}}
\renewcommand{\labelenumii}{{\color{iris}\arabic{enumi}.\arabic{enumii}}}
\renewcommand{\labelenumiii}{{\color{iris}\arabic{enumi}.\arabic{enumii}.\arabic{enumiii}}}
\renewcommand{\labelenumiv}{{\color{iris}\arabic{enumi}.\arabic{enumii}.\arabic{enumiii}.\arabic{enumiv}}}

% Set heading colors
\usepackage{sectsty}
\sectionfont{\color{foam}}
\subsectionfont{\color{rose}}

\def\code#1{\textcolor{iris}{\texttt{#1}}}
\def\bf#1{\textbf{#1}}
\def\ul#1{\underline{#1}}
\def\it#1{\textit{#1}}

% Links
\usepackage{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=pine,
    filecolor=magenta,
    urlcolor=pine,
}

\title{\color{iris}\huge{\bf{\it{Trickanomicon}}}}
\author{\color{muted}Clemson CCDC Team}
\date{\color{subtle}2024}

\begin{document}

\maketitle

\pagebreak

\tableofcontents

\pagebreak

\section{Linux}

\bf{Do not touch the} \code{seccdc\_black} \bf{account}

\subsection{30 Minute Plan}

\begin{enumerate}
	\item Rotate all ssh keys
		\begin{enumerate}
			\item Generate the ssh key from Adrian
			\item Deploy with \code{\bf{ssh-copy-id -i} \ul{identity\_file} [\ul{user}\@\ul{hostname}]}
			\item Remove all other authorized keys with \code{find / -name authorized\_keys}
		\end{enumerate}
	\item Check accounts and reset password \bf{ASAP}
	\item Lock unnecessary accounts with \code{\bf{usermod -L} \ul{LOGIN}} and if nothing goes red, delete account with \code{\bf{userdel -r} \ul{LOGIN}}
	\item Find listening services with \code{ss -lp} and investigate strange ones
\end{enumerate}

\subsection{Monitoring}

\begin{enumerate}
	\item View all network connections \code{ss -tunlp}
	\item View listening programs with \code{ss -lp}
	\item View only connections with \code{ss -tu}
	\item View active processes \code{ps -e}
	\item Continuously see processes with \code{top}
		\begin{enumerate}
			\item Sort by different categories with \code{<} and \code{>}
			\item Tree view with \code{V}
		\end{enumerate}
	\item Watch \bf{all} network traffic with the following (this is a fire hose)
		\begin{enumerate}
			\item Record traffic with \code{iptables -I INPUT -j LOG}
			\item Watch logs with \code{journalctl -kf --grep="IN=.*"}
		\end{enumerate}
	\item Watch dbus with \code{dbus -w}
\end{enumerate}

\subsection{System Utilities}

\begin{enumerate}
	\item Start and stop processes with \code{systemctl}
	\begin{enumerate}
		\item Start service with \code{\bf{systemctl start} [\ul{UNIT}]}
		\item Stop service with \code{\bf{systemctl stop} [\ul{UNIT}]}
		\item Restart service with \code{\bf{systemctl restart} [\ul{UNIT}]}
		\item Enable service with \code{\bf{systemctl enable} [\ul{UNIT}]}
	\end{enumerate}
	\item Permit and allow network connections with \code{iptables}
	\begin{enumerate}
		\item Default deny with \code{iptables -P INPUT DROP}
		\item Allow port access (must choose tcp or udp) \\
			\code{\bf{iptables -A INPUT -p tcp|udp --dport} \ul{port} \bf{-j ACCEPT}}
		\item Allow all from interface \\
			\code{\bf{iptables -A INPUT -i} \ul{interface} \bf{-j ACCEPT}}
	\end{enumerate}
	\item Schedule tasks with cron
	\begin{enumerate}
		\item View with \code{crontab -e}
		\item Obliterate user's crontab with \code{crontab -r}
	\end{enumerate}
	\item View networking information with \code{ip}
		\begin{enumerate}
			\item View network interfaces with \code{ip l}
				\begin{enumerate}
					\item Interfaces are prefixed with an \code{en} to signify ethernet, \code{wl} to signify wireless, and \code{v} to signify a virtual link
					\item Virtual links should be investigated, as they are commonly used for VPNs, docker, and nonsense
					\item Virtual servers will still show their main link to the host as ethernet
				\end{enumerate}
			\item View IP Addresses with \code{ip a} and take note of additional addresses
		\end{enumerate}
\end{enumerate}

\subsection{Configurations}

\begin{enumerate}
	\item SSH Daemon configs are in \code{/etc/ssh/sshd\_config}
		\begin{enumerate}
			\item \code{PermitRootLogin} should be set to \code{prohibit-password}
			\item \code{UsePAM} should be set to \code{no}
			\item \code{PasswordAuthentication} should be set to \code{yes}
			\item \code{PermitEmptyPasswords} should be set to \code{no}
		\end{enumerate}
	\item File system configs are in \code{/etc/fstab}
		\begin{enumerate}
			\item Network File Shares are in the form \\
				\code{/srv/home    hostname1(rw,sync,no\_subtree\_check)} \\
				These allow sharing file systems over the network.  They must be reviewed to ensure we are not sharing information with attackers
		\end{enumerate}
\end{enumerate}

\subsection{Hunting}

\begin{enumerate}
	\item List all files with creation date, most recent first: \code{find /usr /bin /etc /var -type f -exec stat -c "\%W \%n" {} + | sort -r > files}
	\item List all files created after set date, most recent first: \code{find /usr /bin /etc /var -type f -newermt \ul{YYYY-MM-DD} -exec stat -c "\%W \%n" {} + | sort -r > files}
\end{enumerate}

\subsection{Duncan's Magic}

\begin{enumerate}
	\item Remove users listed in disable.txt \\
		\code{while read user;do sudo usermod -L \$user;done<disable.txt}
	\item Reset password from ./users.txt AND output updated passwords to ./changed\_passwords.txt (make sure no ./changed\_passwords.txt exists in directory before hand) \\
		\code{name='NAME HERE' while read user; do password=`tr -dc 'A-Za-z0-9!@\#\$\%' </dev/urandom | head -c 24; echo`; echo "\$name,\$user,\$password" >> changed\_passwords.txt; echo "\$user:\$password" | sudo chpasswd; done < users.txt}
	\item Find users not in ./known\_users.txt \\
		\code{awk -F: '\{if(\$3>=1000\&\&\$3<60000)\{print \$1\}\}' /etc/passwd|sort|comm -13 known\_users.txt ->extra\_users.txt}
\end{enumerate}

\subsection{Hardening}

You should remount /tmp and /var/tmp to be non-executable.
\begin{enumerate}
	\item If /tmp and /var/tmp are already mounted, you can simply do: \code{ \\
		mount -o remount,nodev,nosuid,noexec /tmp \\
		mount -o remount,nodev,nosuid,noexec /var/tmp }
	\item If they haven't already been mounted, edit /etc/fstab to include: \code{ \\
		tmpfs /tmp tmpfs defaults,noatime,nosuid,nodev,noexec,mode=1777 0 0 \\
		tmpfs /var/tmp tmpfs defaults,noatime,nosuid,nodev,noexec,mode=1777 0 0 }
	\item Once /etc/fstab has been updated, you can run: \code{ \\
		mount -o nodev,nosuid,noexec /tmp \\
		mount -o nodev,nosuid,noexec /var/tmp }
\end{enumerate}

\pagebreak

\section{Windows}

\subsection{30 Minute Plan}

\begin{enumerate}
	\item Download \href{https://download.sysinternals.com/files/SysinternalsSuite.zip}{Sysinternals Suite}.
	\item Perform an Nmap scan on machine and note which ports should be accessible.
	\item Change all user account passwords (including your own) except for \bf{seccdc\_black}. \\
		\bf{The following one-liner will reset passwords based on the output files:}
		{ \color{iris} \begin{verbatim}
		import-csv "Team25_$(hostname)-SSH_PWD.csv" -Header "host","user","pass" |
		foreach {net user $_.user $_.pass};
		del "Team25_$(hostname)-SSH_PWD.csv"
		\end{verbatim} }
	\item Disable (or delete) unauthorized user accounts on the system. \\
	\bf{DO NOT DISABLE seccdc\_black AND YOUR USER ACCOUNT}
		\begin{enumerate}
			\item Audit accounts on system:
				{ \color{iris} \begin{verbatim}
				get-localuser | foreach {
					$expected = get-content "users.txt";
					if ($_.Name -notin $expected) {
						echo $_.Name; add-content "unexpected.txt" $_.Name
					}
				}
				\end{verbatim} }
			\item Disable unauthorized accounts:
				{ \color{iris} \begin{verbatim}
				get-content "unexpected.txt" | foreach {net user $_ /active:no}
				\end{verbatim} }
		\end{enumerate}
	\item Find and remove authorized SSH keys. \\
		\code{dir C:\textbackslash{} -Recurse | findstr "authorized\_keys"}

	\item Once Nmap scan completes, configure Firewall.
		\begin{enumerate}
			\item Export current firewall policy. \\
				\code{netsh advfirewall export "C:\textbackslash{}rules.wfw"}
			\item Disable firewall. \\
				\code{netsh advfirewall set allprofiles state off}
			\item Flush inbound/outbound rules. \\
				\code{Remove-NetFirewallRule}
			\item Add rules for RDP (svchost.exe 3389) and SSH (sshd.exe 22). \\
			\code{\$port = <PORT>; New-NetFirewallRule -DisplayName "Inbound \$port" ` \\
			-Direction Inbound -LocalPort \$port -Protocol TCP ` \\
			-Action Allow -Program "Path\textbackslash{}To\textbackslash{}Executable"}
			\item Configure additional rules as needed for scoring/internet (DNS: 53, HTTP: 80/443).
			\item Re-enable firewall to block inbound and outbound (allow outbound on AD). \\
				\code{netsh advfirewall set allprofiles firewallpolicy blockinbound blockoutbound}
				\code{netsh advfirewall set allprofiles state on}
		\end{enumerate}
	\bf{NOTE: Rules should ideally specify applications and source IPs.}
\end{enumerate}

\subsection{Hardening}

\begin{enumerate}
	\item Configure NLA for RDP.
	\item Service Management:
	\begin{enumerate}
		\item Disable Print Spooler. \\
			\code{Set-Service -Name "Spooler" -Status stopped -StartupType disabled}
		\item Disable WinRM. \\
			\code{Disable-PSRemoting -Force}; \\
			\code{Set-Service -Name "WinRM" -Status stopped -StartupType disabled}
		\item Configure SMB:
		\begin{enumerate}
			\item If SMB is unneeded (i.e. not in an AD setting), disable it entirely. \\
				\code{Set-Service -Name "LanmanServer" -Status stopped -StartupType disabled}
			\item If SMB is needed, disable SMBv1. \\
				\code{Disable-WindowsOptionalFeature -Online -FeatureName smb1protocol}
		\end{enumerate}
	\end{enumerate}
	\item Group Policy:
	\begin{enumerate}
		\item Check User Rights Assignment
	\end{enumerate}

\end{enumerate}

\subsection{Monitoring}

\begin{enumerate}
	\item View all network connections with \code{netstat -aonb}. For a live view, use TCPView.
	\item View running processes in the details pane of Task Manager or via Process Explorer.
	\item View all connected Named Pipes / SMB Shares with \code{net use}.
	\item View all connected sessions with \code{qwinsta}.
	\item To get an insight into Powershell activity, enable Powershell Block Logging/Transcription. \\
		\code{Administrative Templates > Windows Components > Windows Powershell}
	\item For an overview of system activity, configure Sysmon with \href{https://github.com/D42H5/cyber_comp_resources/blob/main/sysmonconfig-export-modified-2-2-24.xml}{this config}.
	\begin{enumerate}
		\item To install Sysmon, run \code{sysmon -i <PATH TO CONFIG FILE>}.
		\item Logs are sent to Applications and Services Logs > Microsoft > Windows > Sysmon.
		\item If you want to update your config file, run \code{sysmon -c <PATH TO NEW CONFIG>}.
	\end{enumerate}
	\item You can view system events with the Event Viewer or Nirsoft's \href{https://www.nirsoft.net/utils/fulleventlogview-x64.zip}{EventLogViewer}.
\end{enumerate}

\subsection{Response}

\begin{enumerate}
	\item Kill a connected session with \code{rwinsta <SESSION ID>}.
	\item Kill a process in Task Manager/Process Explorer or with \code{taskkill /f /pid <PID>}.
\end{enumerate}

\subsection{Hunting}

\begin{enumerate}
	\item Install \href{https://downloads.malwarebytes.com/file/mb-windows}{Malwarebytes} and run a system scan. It can be installed silently with: \\
		\code{.\textbackslash{}MBSetup.exe /VERYSILENT /NORESTART}
	\item You can scan the system for unsigned dlls with \code{listdlls -u}.
	\item AccessEnum can be used to search for misconfigured ACLs. Check sensitive registry keys/directories.
	\item The Autoruns utility can be used to find potential persistence mechanisms. The Task Scheduler should also be checked.
	\item You can use BLUESPAWN to aid in hunting. It is a complete EDR solution built for CCDC.
	\begin{enumerate}
		\item It can be obtained from \href{https://github.com/ION28/BLUESPAWN/releases/download/v0.5.1-alpha/BLUESPAWN-client-x64.exe}{here}.
		\item Basic usage is as follows:
		\begin{enumerate}
			\item BLUESPAWN-client-x64.exe --mitigate compares the system to a secure baseline.
			\item BLUESPAWN-client-x64.exe --hunt does a single-pass scan for malicious activity.
			\item BLUESPAWN-client-x64.exe --monitor is like hunt but alerts on new activity.
		\end{enumerate}
	\end{enumerate}
\end{enumerate}

\subsection{Considerations for Active Directory}

The below ports are needed for Active Directory to operate:
{ \color{iris} \begin{verbatim}
	53 TCP/UDP: DNS
	88 TCP/UDP: Kerberos
	123 TCP: NTP
	135 TCP: NetBIOS
	138,139 TCP/UDP: File Replication
	389,636 TCP: LDAP & LDAPS
	445 TCP: SMB
	464 TCP: Kerberos password change
	3268,3269 TCP: Global Catalog LDAP & LDAPS
\end{verbatim} }
\bf{These should be allowed inbound and outbound on a DC and outbound on a DM.}

\begin{enumerate}
	\item Many of the above steps can be done across multiple machines via Group Policy.
	\item The krbtgt password should be reset.
	\item The Domain Administrators group should have minimum membership.
	\item Kerberos authentication attempts should be monitored.
	\item You can force a reset of domain group policy with the below commands:
		{ \color{iris} \begin{verbatim}
	dcgpofix /target:both
	gpupdate /force
		\end{verbatim} }
\end{enumerate}

\subsection{Installing the ELK Stack}

\begin{enumerate}
	\item Install the prerequisites	using manually or using scoop (see below). \\
	\ul{If using scoop, apps are installed in \$HOME/scoop/apps/<APPNAME>/current.}
		\begin{enumerate}
			\item Add the `extras` repository with \code{scoop bucket add extras}.
			\item Add the `java' repository with \code{scoop bucket add java}.
			\item Install elasticsearch and kibana with \code{scoop install elasticsearch kibana openjdk}.
			\item Notepad++ (notepadplusplus) is recommended for editing the yml files.
		\end{enumerate}
	\item Add the following lines to \code{<ELASTICSEARCH DIR>/config/elasticsearch.yml}:
		{ \color{iris} \begin{verbatim}
			xpack.security.enabled: true
			xpack.security.enrollment.enabled: true
			cluster.initial_master_nodes: ["elk"]
			http.host: [_local_, _site_]
		\end{verbatim} }
	\item Start elasticsearch in a Powershell prompt. It will take a moment to initialize.
	\item Reset passwords for the kibana\_system and elastic accounts.
		\begin{enumerate}
			\item \code{<ELASTICSEARCH DIR>/bin/elasticsearch-reset-password -u kibana-system}
			\item \code{<ELASTICSEARCH DIR>/bin/elasticsearch-reset-password -u elastic}
		\end{enumerate}
	\bf{SAVE THESE PASSWORDS SOMEWHERE.}
	\item Add the following lines to \code{<KIBANA DIR>/config/kibana.yml}:
		{ \color{iris} \begin{verbatim}
			server.host: "0.0.0.0"
			server.publicBaseUrl: "http://localhost"
			elasticsearch.hosts: ["http://localhost:9200"]
			elasticsearch.username: "kibana_system"
			elasticsearch.password: "<GENERATED KIBANA-SYSTEM PASSWORD>"
			elasticsearch.ssl.verificationMode: none
		\end{verbatim} }
	\item Stop the elasticsearch executable and install it as a service with: \\
		\code{<ELASTICSEARCH DIR>/bin/elasticsearch-service.bat install}
	\item Start the elasticsearch service with \code{start-service elasticsearch-service-x64}
	\item Start kibana in a Powershell prompt. It will take a moment to initialize.
	\item You may now log into kibana at localhost:5601 with the elastic account.
\end{enumerate}

\subsection{Configuring Winlogbeat}

\begin{enumerate}
	\item You can obtain Winlogbeat from \href{https://artifacts.elastic.co/downloads/beats/winlogbeat/winlogbeat-8.12.0-windows-x86_64.zip}{here}.
	\item Extract the Winlogbeat directory to C:\textbackslash{}Program Files.
	\item Edit the winlogbeat.yml file as needed for environment and log forwarding.
	\item Install Winlogbeat as a service with \code{.\textbackslash{}install-service-winlogbeat.ps1}
	\item Load the prebuilt Winlogbeat assets with \code{.\textbackslash{}winlogbeat.exe setup -e}.
	\item Start the Winlogbeat service with \code{start-service winlogbeat}
\end{enumerate}

\section{Service Configuration}

\subsection{MySQL}

\begin{enumerate}
	\item Change passwords for any non-scored users. \\
		\code{SELECT User, Host FROM mysql.user;} \\
		\code{ALTER USER '<USERNAME>'@<HOST> IDENTIFIED BY '<NEW PASSWORD>';}
	\item Drop unauthorized users. \\
		\code{SELECT User, Host FROM mysql.user;} \\
		\code{DROP USER '<USERNAME>'@<HOST>; }
	\item Prepare a database backup and store somewhere safe \bf{off the system}.
	\begin{enumerate}
		\item Backup: \code{mysqldump -u <USERNAME> -p --all-databses > <BACKUP PATH>}
		\item Restore: \code{mysql -u <USERNAME> -p < <BACKUP PATH>} \\
	\end{enumerate}
\end{enumerate}

\subsection{FTP}

\bf{ANONYMOUS ACCESS CANNOT BE DISABLED.}

\begin{enumerate}
	\item On Windows, you will interact with the IIS console to manage FTP.
	\item On Linux, you will interact with /etc/vsftpd.conf (probably).
	\item Manage anonymous permissions to only allow reads (and writes if needed).
	\item Restrict access to non-shared directories from anonymous users.
	\item Prevent executables from running in the shared directory.
\end{enumerate}

\subsection{SSH}

\begin{enumerate}
	\item Check the SSH config file for potential misconfigurations.
	\begin{enumerate}
		\item `PermitRootLogin` should be set to `no`
		\item `PermitEmptyPasswords` should be set to `no`
	\end{enumerate}
	\item You can tunnel a port over ssh with the following syntax: \\
		\code{ssh -L <LPORT>:<RHOST>:<RPORT> <USER>@<RHOST>}
\end{enumerate}

\subsection{Web Servers}

\begin{enumerate}
	\item With IIS, some hardening can be automated with \href{https://github.com/ufsitblue/blue/blob/main/dsu_blue/windows/IIS.ps1}{this script}.
	\item (If applicable) Change passwords for user accounts on website.
	\item Ensure that directory listing is disabled.
	\item Check web server directory for php webshells.
	\begin{enumerate}
		\item Webshells are likely to have malicious phrases like exec in the php file.
		\item You can minimize the possibility of this attack by disabling the phrases outright.
		\item Run php --ini to list all of the config files currently loaded into php.
		\item Add the following lines to the end of each config file:
	\end{enumerate}
\end{enumerate}

{ \color{iris} \begin{verbatim}
# the below needs to be on one line
disable_functions=exec,passthru,shell_exec,system,proc_open,
popen,curl_exec,curl_multi_exec,parse_ini_file,show_source
# disable file uploads if they aren't needed
file_uploads=off
allow_url_fopen=off
allow_url_include=off
\end{verbatim} }

\end{document}
